<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>OMR Sheet Processor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .preview-img,
    .result-img {
      width: 100%;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 5px;
    }

    .panel {
      min-height: 400px;
    }

    #fileInput {
      display: none;
    }
  </style>
</head>

<body class="bg-light">

  <div class="container-fluid py-4">
    <h2 class="text-center mb-4 text-primary">OMR Sheet</h2>

    <!-- Upload / Camera Section -->
    <div class="d-flex justify-content-center align-items-center" style="min-height: 15vh;">
      <div style="width: 100%; max-width: 400px;">
        <h5 class="text-center mb-3">Upload Key Sheet</h5>
        <form id="uploadForm">
          <input type="file" id="fileInput" accept="image/*" capture="environment" required>
          <button type="button" id="cameraBtn" class="btn btn-success w-100 mb-2">üì∑ Open Camera</button>
          <button type="submit" class="btn btn-primary w-100">Upload & Process</button>
        </form>
      </div>
    </div>

    <!-- Preview and Processed Result -->
    <div class="row">
      <div class="col-md-6 panel text-center">
        <h6>Preview:</h6>
        <img id="preview" class="preview-img" src="https://dummyimage.com/300x300/cccccc/000000.png&text=Preview"
          alt="Preview will appear here" style="height: 300px; object-fit: contain; width: 100%;">
      </div>

      <div class="col-md-6 panel text-center">
        <h5>Processed Result</h5>
        <img id="resultImg" class="result-img" src="" alt="Processed image will appear here"
          style="height: 300px; object-fit: contain; width: 100%;">
      </div>
    </div>

    <!-- Exam Info -->
    <div class="row mt-4">
      <div class="col-md-8 offset-md-2 text-center">
        <h6 class="fw-bold text-secondary">Exam Info</h6>
        <p id="examInfo" class="text-muted"></p>
      </div>
    </div>

    <!-- Bottom Section: JSON Table -->
    <div class="row mt-4">
      <div class="col-md-10 offset-md-1 text-center">
        <h5>Detected Answers</h5>

        <!-- Action buttons -->
        <div class="mb-3">
          <button id="editBtn" class="btn btn-warning me-2" disabled>‚úèÔ∏è Edit</button>
          <button id="submitBtn" class="btn btn-success" disabled>‚úÖ Submit Changes</button>
        </div>

        <table class="table table-bordered table-striped" id="resultTable">
          <thead class="table-dark">
            <tr>
              <th>Question</th>
              <th>Answer(s)</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rows will be inserted dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("fileInput");
    const cameraBtn = document.getElementById("cameraBtn");
    const preview = document.getElementById("preview");
    const resultImg = document.getElementById("resultImg");
    const resultTableBody = document.querySelector("#resultTable tbody");
    const examInfo = document.getElementById("examInfo");
    const editBtn = document.getElementById("editBtn");
    const submitBtn = document.getElementById("submitBtn");

    // Get sucCode and examID from localStorage
    let sucCode = localStorage.getItem("sucCode");
    let examID = localStorage.getItem("examId");

    if (!sucCode || !examID) {
      alert("SUC Code or Exam ID not found. Please scan QR code first!");
      window.location.href = "scan.html"; // redirect to your scanner page
    }

    let currentData = []; // store processed answers
    let editable = false; // track edit mode

    cameraBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (file) preview.src = URL.createObjectURL(file);
    });

    uploadForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const file = fileInput.files[0];
      if (!file) return alert("Please capture or upload an image first!");

      const formData = new FormData();
      formData.append("file", file);

      const apiUrl = `https://0e74bbcb1da7.ngrok-free.app/process/${sucCode}/${examID}`;

      try {
        const response = await fetch(apiUrl, { method: "POST", body: formData });
        if (!response.ok) throw new Error("Upload failed!");
        const data = await response.json();

        // Update localStorage (optional, in case backend modifies them)
        sucCode = data.suc || sucCode;
        examID = data.examID || examID;
        localStorage.setItem("sucCode", sucCode);
        localStorage.setItem("examId", examID);

        resultImg.src = "https://0e74bbcb1da7.ngrok-free.app" + data.image_url;
        examInfo.innerText = `SUC Code: ${sucCode} | Exam ID: ${examID}`;

        currentData = data.result; // store for later edits
        renderTable(currentData, false); // render in "view" mode

        editBtn.disabled = false; // enable edit button
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    // Render table
    function renderTable(data, editableMode) {
      resultTableBody.innerHTML = "";
      data.forEach(item => {
        const row = document.createElement("tr");

        // Question cell
        const qCell = document.createElement("td");
        qCell.innerText = item.question;
        row.appendChild(qCell);

        // Answer cell
        const aCell = document.createElement("td");

        if (editableMode) {
          const input = document.createElement("input");
          input.type = "text";
          input.value = item.answers.length > 0 ? item.answers.join(", ") : "";
          input.className = "form-control text-center";
          input.dataset.question = item.question;
          aCell.appendChild(input);
        } else {
          aCell.innerText = item.answers.length > 0 ? item.answers.join(", ") : "Not Answered";
          aCell.className = item.answers.length > 0 ? "text-success" : "text-danger";
        }

        row.appendChild(aCell);
        resultTableBody.appendChild(row);
      });
    }

    // Edit button ‚Üí switch to edit mode
    editBtn.addEventListener("click", () => {
      editable = true;
      renderTable(currentData, true);
      editBtn.disabled = true;
      submitBtn.disabled = false;
    });

    // Submit button ‚Üí collect inputs & send to backend
    submitBtn.addEventListener("click", async () => {
      const inputs = document.querySelectorAll("#resultTable input");
      const updatedAnswers = [];

      inputs.forEach(input => {
        updatedAnswers.push({
          question: input.dataset.question,
          answer: input.value.trim()
        });
      });

      try {
        const submitUrl = `https://0e74bbcb1da7.ngrok-free.app/save_results`;
        const res = await fetch(submitUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            suc: sucCode,
            examID: examID,
            answers: updatedAnswers
          })
        });

        if (!res.ok) throw new Error("Failed to submit updates");
        alert("Answers updated successfully!");

        // update currentData and re-render in view mode
        currentData = updatedAnswers.map(item => ({
          question: item.question,
          answers: item.answer ? [item.answer] : []
        }));
        renderTable(currentData, false);

        editBtn.disabled = false;
        submitBtn.disabled = true;
      } catch (err) {
        alert("Update failed: " + err.message);
      }
    });
  </script>
</body>


</html>
