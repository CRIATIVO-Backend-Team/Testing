<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>OMR Sheet Processor - Result</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Vendor CSS -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">

  <style>
    body {
      font-family: "Nunito", sans-serif;
      background: #f8f9fa;
    }

    .card-custom {
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      background: #fff;
      margin-bottom: 1rem;
    }

    .result-img {
      width: 100%;
      border-radius: 12px;
      border: 2px dashed #dee2e6;
      height: 260px;
      object-fit: contain;
    }

    table th,
    table td {
      border: 1px solid #d6cfcf !important;
    }

    .badge-success {
      color: #2eca6a;
      background: #e0f8e9;
    }

    .badge-failed {
      color: #dc3545;
      background: #fdecea;
    }
  </style>
</head>

<body>
  <div class="container py-4">

    <h1 class="fs-4 mb-4">OMR Sheet Processed Result</h1>

    <!-- Processed Image -->
    <div class="card card-custom p-3 mb-4 text-center">
      <h6 class="text-start mb-2">Processed Sheet</h6>
      <img id="resultImg" class="result-img" src="assets/img/processed.png" alt="Processed image">
    </div>

    <!-- Exam Info -->
    <div class="card card-custom p-3 mb-4">
      <h6 class="text-dark mb-2">Exam Info</h6>
      <div class="d-flex justify-content-between">
        <div>
          <span class="fw-semibold text-muted" style="font-size: 12px;">SUC Code:</span>
          <div class="text-dark" id="sucCode">-</div>
        </div>
        <div>
          <span class="fw-semibold text-muted" style="font-size: 12px;">Exam ID:</span>
          <div class="text-dark" id="examID">-</div>
        </div>
      </div>
    </div>

    <!-- Detected Answers Table -->
    <div class="card card-custom p-4 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="text-dark mb-0">Detected Answers</h6>
        <div>
          <button id="editBtn" class="btn btn-sm btn-outline-primary">Edit</button>
          <button id="submitBtn" class="btn btn-sm btn-success" disabled>Submit</button>
        </div>
      </div>
      <div class="table-responsive" style="height: 300px; overflow-y: auto;">
        <table class="table align-middle text-center" id="resultTable">
          <thead class="table-primary sticky-top">
            <tr>
              <th>Question</th>
              <th>Answer(s)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    let currentData = [];
    let sucCode = "-";
    let examID = "-";

    // Load stored data (from upload.html or API)
    const dataStr = localStorage.getItem("omrResultData");
    if (!dataStr) {
      alert("No result data found. Please upload an OMR sheet first.");
    } else {
      const data = JSON.parse(dataStr);

      // Set exam info
      sucCode = data.suc || "-";
      examID = data.examID || "-";
      document.getElementById("sucCode").innerText = sucCode;
      document.getElementById("examID").innerText = examID;

      // Set processed image
      const imgUrl = data.image_url.startsWith("http") ? data.image_url : "https://w.aditya.ac.in/omrapi" + data.image_url;
      document.getElementById("resultImg").src = imgUrl + "?t=" + new Date().getTime();

      // Save to currentData
      currentData = data.result.map(item => ({
        question: item.question,
        answers: item.answers
      }));

      renderTable(currentData, false);
    }

    function renderTable(data, editableMode) {
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";
      data.forEach(item => {
        const tr = document.createElement("tr");

        const qCell = document.createElement("td");
        qCell.innerText = item.question;
        tr.appendChild(qCell);

        const aCell = document.createElement("td");
        if (editableMode) {
          const input = document.createElement("input");
          input.type = "text";
          input.value = item.answers.join(", ");
          input.className = "form-control form-control-sm text-center";
          input.dataset.question = item.question;
          aCell.appendChild(input);
        } else {
          if (item.answers.length > 0) {
            aCell.innerHTML = `<span class="badge badge-success">${item.answers.join(", ")}</span>`;
          } else {
            aCell.innerHTML = `<span class="badge badge-failed">Not Answered</span>`;
          }
        }
        tr.appendChild(aCell);
        tbody.appendChild(tr);
      });
    }

    // Buttons
    const editBtn = document.getElementById("editBtn");
    const submitBtn = document.getElementById("submitBtn");

    editBtn.addEventListener("click", () => {
      renderTable(currentData, true);
      editBtn.disabled = true;
      submitBtn.disabled = false;
    });

    submitBtn.addEventListener("click", async () => {
      const inputs = document.querySelectorAll("#resultTable input");
      const updatedAnswers = Array.from(inputs).map(input => ({
        question: input.dataset.question,
        answers: input.value.trim() ? input.value.split(",").map(a => a.trim()) : []
      }));

      try {
        const res = await fetch("https://w.aditya.ac.in/omrapi/save_results", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            suc: sucCode,
            examID: examID,
            answers: updatedAnswers
          })
        });

        if (!res.ok) throw new Error("Submission failed!");

        // Save updated data locally
        currentData = updatedAnswers;
        localStorage.setItem("omrResultData", JSON.stringify({
          suc: sucCode,
          examID: examID,
          image_url: document.getElementById("resultImg").src,
          result: currentData
        }));

        renderTable(currentData, false);
        editBtn.disabled = false;
        submitBtn.disabled = true;

        alert("Answers updated successfully!");
      } catch (err) {
        alert("Update failed: " + err.message);
      }
    });
  </script>

</body>
</html>
